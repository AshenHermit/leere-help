<!DOCTYPE html>
<html>

<head>
    <script>
        async function logout() {
            let res = await fetch(location.origin+"/api/logout/", {credentials: "include"})
            let data = await res.json()
            location.href='/'
        }
    </script>
    <title>Task List</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            border-style: hidden;
            box-shadow: 0 0 0 1px #666;
        }

        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        button {
            border-radius: 10px;
            border-width: 1px;
            cursor: pointer;
        }
    </style>

    <script>
        var taskPK = null;

        var tasks = {{ tasks_map }};
        var taskKeys = ["completed", "title", "description", "department_pk"]
        function getValues() {
            let values = {}
            taskKeys.forEach(k => {
                let el = document.getElementById(k)
                if (el) values[k] = el.value
            })
            values["completed"] = document.getElementById("completed").checked
            return values
        }
        function setValues(values) {
            taskKeys.forEach(k => {
                let el = document.getElementById(k)
                if (el) el.value = values[k]
            })
            document.getElementById("completed").checked = values["completed"]
        }

        function editNewTask() {
            taskPK = null
            let values = {}
            taskKeys.forEach(k => { values[k] = "" })
            setValues(values)
            openModal()
        }
        function editTask(editTaskPK) {
            taskPK = editTaskPK
            setValues(tasks[editTaskPK])
            openModal()
        }

        async function saveTask() {
            let payload = { pk: taskPK, ...getValues() }
            let res = await fetch(location.origin + "/api/tasks/save", {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: "include", body: JSON.stringify(payload),
                method: "POST",
            })
            let data = await res.json()

            document.getElementById("result").innerHTML = JSON.stringify(data)

            if (data.data) {
                location.reload()
            }
        }
        async function deleteTask(taskPK) {
            let payload = { pk: taskPK }
            let res = await fetch(location.origin + "/api/tasks/delete", {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: "include", body: JSON.stringify(payload),
                method: "POST",
            })
            let data = await res.json()

            document.getElementById("result").innerHTML = JSON.stringify(data)

            if (data.data) {
                location.reload()
            }
        }

        function openModal() {
            document.getElementById("task_modal").style.display = "flex";
        }
        function closeModal() {
            document.getElementById("task_modal").style.display = "none";
        }
        function hideTaskEditingElements(task) {

        }
        function setupReports() {

        }
        window.addEventListener("load", () => {
            Object.keys(tasks).forEach(pk => {
                const task = tasks[pk]
                let editEl = document.getElementById("task_edit_" + pk)
                if (editEl) editEl.style.display = task.can_edit ? "block" : "none"

                let reportContainer = document.getElementById("task_reports_" + pk)
                if (reportContainer) {
                    let reportAdd = reportContainer.getElementsByClassName("reports_add")[0]
                    reportAdd.style.display = task.can_add_report ? "block" : "none"

                    let reportList = reportContainer.getElementsByClassName("reports_list")[0]
                    Object.keys(task.reports).forEach(reportPk => {
                        var link = document.createElement("a")
                        link.innerHTML = "üìÑ"
                        link.target = "_blank"
                        link.href = "/reports/" + reportPk
                        reportList.appendChild(link)
                    })
                }
            })
        })
        document.addEventListener("click", (e) => {
            if (e.target.id == "task_modal") closeModal()
        })
    </script>
</head>

<body
    style="display: flex; flex-direction: column; gap: 8px; margin: 0; padding: 16px; font-family: monospace;font-size: 14px;">
    <div>{{user.name}}</div>
    <h1>–ó–∞–¥–∞—á–∏</h1>
    <table>
        <thead>
            <tr>
                <th>–Ω–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–∞–≤—Ç–æ—Ä</th>
                <th>–æ—Ç–¥–µ–ª</th>
                <th>–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
                <!-- <th>–æ—Ç—á–µ—Ç—ã</th> -->
                {% if can_create_task %}
                <th>—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.description }}</td>
                <td>{{ task.author.name }} <span style="opacity: 0.5;">[{{task.author.position.name}}]</span></td>
                <td>{{ task.department.name }}</td>
                <td>{{ task.completed|yesno:"‚úÖ,‚ùå" }}</td>
                <!-- <td>
                    <div id="task_reports_{{task.pk}}" style="display: flex; gap: 8px;">
                        <div class="reports_list">

                        </div>
                        <button class="reports_add" style="font-size: 20px;"> + </button>
                    </div>
                </td> -->
                {% if can_create_task %}
                <td>
                    <div id="task_edit_{{task.pk}}">
                        <button onclick="editTask('{{task.pk}}')">‚úèÔ∏è</button>
                        <button onclick="deleteTask('{{task.pk}}')">üóëÔ∏è</button>
                    </div>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if can_create_task %}
    <button style="font-size: 20px; width: 100%;" onclick="editNewTask()">+</button>
    <div id="task_modal" style="display: none; position: absolute; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div
            style="position: absolute; display: flex; flex-direction: column; gap: 8px; width: 50%; height: 50%; padding: 20px; background-color: #fff; border-radius: 8px;">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
            <div>
                <div>–Ω–∞–∑–≤–∞–Ω–∏–µ</div>
                <input id="title" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ" style="width: 400px;" />
            </div>
            <div>
                <div>–æ–ø–∏—Å–∞–Ω–∏–µ</div>
                <textarea id="description" placeholder="–æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            </div>
            <div>
                <div>–æ—Ç–¥–µ–ª</div>
                <select name="select" id="department_pk">
                    {% for dep in departments %}
                    <option value="{{dep.pk}}">{{dep.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <input type="checkbox" id="completed" name="completed" />
                <label for="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
            <div>
                <button onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div id="result"></div>
        </div>
    </div>
    {% endif %}
</body>

</html>